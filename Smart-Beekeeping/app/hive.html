<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Hive Conditions - Smart Nyuki</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/smart-nyuki-theme.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0 navbar-dark">
            <!-- ...existing code... -->
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-expand bg-white shadow mb-4 topbar static-top navbar-light">
                    <!-- ...existing code... -->
                </nav>
                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h3 class="text-dark mb-0" id="hiveLocation">Hive Conditions</h3>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-primary py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                                                <span>Temperature</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="temperature">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-temperature-high fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-success py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-success fw-bold text-xs mb-1">
                                                <span>Humidity</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="humidity">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-tint fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-info py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-info fw-bold text-xs mb-1">
                                                <span>Weight</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="weight">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-weight fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-warning py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-warning fw-bold text-xs mb-1">
                                                <span>Sound Level</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="sound">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-volume-up fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-7 col-xl-8">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">24-Hour Metrics Overview</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="metricsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Individual Metric Charts -->
                            <div class="row">
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-primary fw-bold m-0">Temperature Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="temperatureChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-success fw-bold m-0">Humidity Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="humidityChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-info fw-bold m-0">Weight Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="weightChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-warning fw-bold m-0">Sound Level Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="soundChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-xl-4">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Alert Thresholds</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-primary mb-2">
                                        <strong>Temperature:</strong>
                                        <br>Min: 32°C | Max: 37°C
                                        <div class="small text-gray-500">Current: <span id="temperature-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-success mb-2">
                                        <strong>Humidity:</strong>
                                        <br>Min: 50% | Max: 75%
                                        <div class="small text-gray-500">Current: <span id="humidity-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-info mb-2">
                                        <strong>Weight:</strong>
                                        <br>Min: 1.2kg | Max: 1.6kg
                                        <div class="small text-gray-500">Current: <span id="weight-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-warning mb-2">
                                        <strong>Sound Level:</strong>
                                        <br>Min: 30dB | Max: 60dB
                                        <div class="small text-gray-500">Current: <span id="sound-status">Normal</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary fw-bold m-0">Hive Health Indicators</h6>
                                </div>
                                <div class="card-body">
                                    <h4 class="small fw-bold">Temperature Stability<span class="float-end" id="temp-stability">Loading...</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-success" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span class="visually-hidden">Loading...</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Humidity Balance<span class="float-end" id="humidity-balance">Loading...</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-info" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span class="visually-hidden">Loading...</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Colony Activity<span class="float-end" id="colony-activity">Loading...</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-primary" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span class="visually-hidden">Loading...</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Honey Production<span class="float-end" id="honey-production">Loading...</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-warning" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span class="visually-hidden">Loading...</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary fw-bold m-0">Status Indicators</h6>
                                </div>
                                <div class="row p-3">
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-primary shadow">
                                            <div class="card-body">
                                                <p class="m-0">Temperature Status</p>
                                                <p class="text-white-50 small m-0" id="temperature-indicator">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-success shadow">
                                            <div class="card-body">
                                                <p class="m-0">Humidity Status</p>
                                                <p class="text-white-50 small m-0" id="humidity-indicator">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-info shadow">
                                            <div class="card-body">
                                                <p class="m-0">Weight Status</p>
                                                <p class="text-white-50 small m-0" id="weight-indicator">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-warning shadow">
                                            <div class="card-body">
                                                <p class="m-0">Sound Status</p>
                                                <p class="text-white-50 small m-0" id="sound-indicator">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © Smart Nyuki 2025</span></div>
                </div>
            </footer>
        </div>
        <a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="assets/js/script.min.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadHive();
        });

        async function loadHive() {
            try {
                const user = await getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const hiveId = urlParams.get('id');
                if (!hiveId) {
                    alert('No hive selected.');
                    window.location.href = 'index.html';
                    return;
                }

                const { data: hive, error: hiveError } = await supabaseClient
                    .from('hive_details')
                    .select('node_id, location, hive_type')
                    .eq('id', hiveId)
                    .single();

                if (hiveError) {
                    console.error('Database error:', hiveError);
                    throw hiveError;
                }

                document.getElementById('hiveLocation').textContent = `${hive.location} (${hive.hive_type})`;

                const { data: hiveData, error: hiveDataError } = await supabaseClient
                    .from('hives')
                    .select('created_at, temperature, humidity, weight, sound')
                    .eq('node_id', hive.node_id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (hiveDataError) {
                    console.error('Database error:', hiveDataError);
                    throw hiveDataError;
                }

                if (!hiveData || hiveData.length === 0) {
                    alert('No data found for this hive.');
                    return;
                }

                const latestData = hiveData[0];
                updateDashboardValues(latestData);

                // Load historical data for the chart
                const { data: historicalData, error: historicalDataError } = await supabaseClient
                    .from('hives')
                    .select('created_at, temperature, humidity, weight, sound')
                    .eq('node_id', hive.node_id)
                    .order('created_at', { ascending: true });

                if (historicalDataError) {
                    console.error('Database error:', historicalDataError);
                    throw historicalDataError;
                }

                if (historicalData && historicalData.length > 0) {
                    updateChart(historicalData);
                }

            } catch (error) {
                console.error('Error loading hive:', error);
                alert(error.message || 'Failed to load hive. Please try again.');
            }
        }

        // Update dashboard values
        function updateDashboardValues(data) {
            // Update main metrics
            document.getElementById('temperature').textContent = `${data.temperature.toFixed(1)}°C`;
            document.getElementById('humidity').textContent = `${data.humidity.toFixed(1)}%`;
            document.getElementById('weight').textContent = `${(data.weight / 1000).toFixed(1)} kg`;
            document.getElementById('sound').textContent = `${data.sound.toFixed(0)}dB`;

            // Update status indicators
            updateStatus('temperature', data.temperature);
            updateStatus('humidity', data.humidity);
            updateStatus('weight', data.weight / 1000); // Convert to kg
            updateStatus('sound', data.sound);

            // Update health indicators
            updateHealthIndicators(data);
        }

        function updateChart(historicalData) {
            if (!window.metricsChart) return;

            // Filter data for last 24 hours
            const now = new Date().getTime();
            const last24Hours = now - (24 * 60 * 60 * 1000);
            const filteredData = historicalData.filter(d => new Date(d.created_at).getTime() > last24Hours);

            const timestamps = filteredData.map(d => new Date(d.created_at).getTime());

            // Update main overview chart
            window.metricsChart.data.labels = timestamps;
            window.metricsChart.data.datasets[0].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.temperature
            }));
            window.metricsChart.data.datasets[1].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.humidity
            }));
            window.metricsChart.data.datasets[2].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.weight / 1000 // Convert to kg
            }));
            window.metricsChart.data.datasets[3].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.sound
            }));
            window.metricsChart.update();

            // Update individual charts with filtered data
            if (window.temperatureChart) {
                window.temperatureChart.data.labels = timestamps;
                window.temperatureChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.temperature
                }));
                window.temperatureChart.update();
            }

            if (window.humidityChart) {
                window.humidityChart.data.labels = timestamps;
                window.humidityChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.humidity
                }));
                window.humidityChart.update();
            }

            if (window.weightChart) {
                window.weightChart.data.labels = timestamps
