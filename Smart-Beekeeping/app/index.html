<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Dashboard - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/smart-nyuki-theme.css">
    <style>
        /* All styles moved to smart-nyuki-theme.css */
    </style>
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0 navbar-dark">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-bee"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>Smart Nyuki</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link active" href="index.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"><a class="nav-link" href="table.html"><i class="fas fa-table"></i><span>Table</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="manage-my-bees.html"><i class="fas fa-map-marker-alt"></i><span>Manage My Bees</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="add-hive.html"><i class="fas fa-plus-circle"></i><span>Add Hive</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="alerts.html"><i class="fas fa-bell"></i><span>Alerts</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="messages.html"><i class="fas fa-envelope"></i><span>Messages</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-expand bg-white shadow mb-4 topbar static-top navbar-light">
                    <div class="container-fluid">
                        <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button">
                            <i class="fas fa-bars"></i>
                        </button>
                        <form class="d-none d-sm-inline-block me-auto ms-md-3 my-2 my-md-0 mw-100 navbar-search">
                            <div class="input-group"><input class="bg-light form-control border-0 small" type="text" placeholder="Search for ..."><button class="btn btn-primary py-0" type="button"><i class="fas fa-search"></i></button></div>
                        </form>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown d-sm-none no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><i class="fas fa-search"></i></a>
                                <div class="dropdown-menu dropdown-menu-end p-3 animated--grow-in" aria-labelledby="searchDropdown">
                                    <form class="me-auto navbar-search w-100">
                                        <div class="input-group"><input class="bg-light border-0 form-control small" type="text" placeholder="Search for ..."><button class="btn btn-primary" type="button"><i class="fas fa-search"></i></button></div>
                                    </form>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow">
                                    <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#">
                                        <span class="badge bg-danger badge-counter" id="alertsCount"></span>
                                        <i class="fas fa-bell fa-fw"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">Alerts Center</h6>
                                        <div id="alertsDropdown">
                                            <!-- Latest alerts will be loaded here -->
                                        </div>
                                        <a class="dropdown-item text-center small text-gray-500" href="alerts.html">Show All Alerts</a>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow">
                                    <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#">
                                        <span class="badge bg-danger badge-counter" id="messagesCount"></span>
                                        <i class="fas fa-envelope fa-fw"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">Messages Center</h6>
                                        <div id="messagesDropdown">
                                            <!-- Latest messages will be loaded here -->
                                        </div>
                                        <a class="dropdown-item text-center small text-gray-500" href="messages.html">Show All Messages</a>
                                    </div>
                                </div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow">
                                    <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#">
                                        <span class="d-none d-lg-inline me-2 text-gray-600 small">Loading...</span>
                                        <img class="border rounded-circle img-profile" src="https://ui-avatars.com/api/?background=0D8ABC&color=fff" alt="Profile">
                                    </a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in">
                                        <a class="dropdown-item" href="profile.html">
                                            <i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>Profile
                                        </a>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-cogs fa-sm fa-fw me-2 text-gray-400"></i>Settings
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#" onclick="handleLogout()">
                                            <i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>Logout
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h3 class="text-dark mb-0">Hive Monitoring Dashboard</h3>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-primary py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-primary fw-bold text-xs mb-1">
                                                <span>Temperature</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="temperature">35.2Â°C</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-temperature-high fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-success py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-success fw-bold text-xs mb-1">
                                                <span>Humidity</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="humidity">65%</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-tint fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-info py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-info fw-bold text-xs mb-1">
                                                <span>Weight</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="weight">25.5 kg</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-weight fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-3 mb-4">
                            <div class="card shadow border-left-warning py-2">
                                <div class="card-body">
                                    <div class="row g-0 align-items-center">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-warning fw-bold text-xs mb-1">
                                                <span>Sound Level</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0">
                                                <span id="sound">45 dB</span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-volume-up fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-7 col-xl-8">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">24-Hour Metrics Overview</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="metricsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Individual Metric Charts -->
                            <div class="row">
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-primary fw-bold m-0">Temperature Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="temperatureChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-success fw-bold m-0">Humidity Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="humidityChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-info fw-bold m-0">Weight Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="weightChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-6 mb-4">
                                    <div class="card shadow">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="text-warning fw-bold m-0">Sound Level Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-area">
                                                <canvas id="soundChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-xl-4">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Alert Thresholds</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-primary mb-2">
                                        <strong>Temperature:</strong>
                                        <br>Min: 32Â°C | Max: 37Â°C
                                        <div class="small text-gray-500">Current: <span id="temperature-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-success mb-2">
                                        <strong>Humidity:</strong>
                                        <br>Min: 50% | Max: 75%
                                        <div class="small text-gray-500">Current: <span id="humidity-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-info mb-2">
                                        <strong>Weight:</strong>
                                        <br>Min: 1.2kg | Max: 1.6kg
                                        <div class="small text-gray-500">Current: <span id="weight-status">Normal</span></div>
                                    </div>
                                    <div class="alert alert-warning mb-2">
                                        <strong>Sound Level:</strong>
                                        <br>Min: 30dB | Max: 60dB
                                        <div class="small text-gray-500">Current: <span id="sound-status">Normal</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary fw-bold m-0">Hive Health Indicators</h6>
                                </div>
                                <div class="card-body">
                                    <h4 class="small fw-bold">Temperature Stability<span class="float-end" id="temp-stability">90%</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-success" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 90%;"><span class="visually-hidden">90%</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Humidity Balance<span class="float-end" id="humidity-balance">80%</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-info" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 80%;"><span class="visually-hidden">80%</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Colony Activity<span class="float-end" id="colony-activity">75%</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-primary" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"><span class="visually-hidden">75%</span></div>
                                    </div>
                                    <h4 class="small fw-bold">Honey Production<span class="float-end" id="honey-production">70%</span></h4>
                                    <div class="progress mb-4">
                                        <div class="progress-bar bg-warning" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width: 70%;"><span class="visually-hidden">70%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary fw-bold m-0">Status Indicators</h6>
                                </div>
                                <div class="row p-3">
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-primary shadow">
                                            <div class="card-body">
                                                <p class="m-0">Temperature Status</p>
                                                <p class="text-white-50 small m-0" id="temperature-indicator">Optimal Range</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-success shadow">
                                            <div class="card-body">
                                                <p class="m-0">Humidity Status</p>
                                                <p class="text-white-50 small m-0" id="humidity-indicator">Normal Levels</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-info shadow">
                                            <div class="card-body">
                                                <p class="m-0">Weight Status</p>
                                                <p class="text-white-50 small m-0" id="weight-indicator">Healthy Growth</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <div class="card text-white bg-warning shadow">
                                            <div class="card-body">
                                                <p class="m-0">Sound Status</p>
                                                <p class="text-white-50 small m-0" id="sound-indicator">Normal Activity</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright Â© Smart Nyuki 2025</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="assets/js/script.min.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            initializeChart();
            await startMonitoring();
        });

        // Initialize all charts
        function initializeChart() {
            const commonOptions = {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                millisecond: 'HH:mm:ss',
                                second: 'HH:mm:ss',
                                minute: 'HH:mm',
                                hour: 'MMM D, HH:mm',
                                day: 'MMM D',
                                week: 'MMM D',
                                month: 'MMM YYYY',
                                quarter: 'MMM YYYY',
                                year: 'YYYY'
                            },
                            tooltipFormat: 'MMM D, YYYY HH:mm'
                        },
                        grid: {
                            display: true,
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                        },
                        ticks: {
                            padding: 5
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return moment(tooltipItems[0].parsed.x).format('MMM D, YYYY HH:mm');
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 10,
                            usePointStyle: true
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    line: {
                        tension: 0.4
                    },
                    point: {
                        radius: 2,
                        hitRadius: 4,
                        hoverRadius: 4
                    }
                }
            };

            // Main overview chart
            const ctx = document.getElementById('metricsChart').getContext('2d');
            window.metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (Â°C)',
                            borderColor: '#4e73df',
                            data: [],
                            fill: false
                        },
                        {
                            label: 'Humidity (%)',
                            borderColor: '#1cc88a',
                            data: [],
                            fill: false
                        },
                        {
                            label: 'Weight (kg)',
                            borderColor: '#36b9cc',
                            data: [],
                            fill: false
                        },
                        {
                            label: 'Sound (dB)',
                            borderColor: '#f6c23e',
                            data: [],
                            fill: false
                        }
                    ]
                },
                options: commonOptions
            });

            // Individual metric charts with the same time formatting
            window.temperatureChart = new Chart(document.getElementById('temperatureChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (Â°C)',
                        borderColor: '#4e73df',
                        data: [],
                        fill: true,
                        backgroundColor: 'rgba(78, 115, 223, 0.1)'
                    }]
                },
                options: commonOptions
            });

            window.humidityChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humidity (%)',
                        borderColor: '#1cc88a',
                        data: [],
                        fill: true,
                        backgroundColor: 'rgba(28, 200, 138, 0.1)'
                    }]
                },
                options: commonOptions
            });

            window.weightChart = new Chart(document.getElementById('weightChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Weight (kg)',
                        borderColor: '#36b9cc',
                        data: [],
                        fill: true,
                        backgroundColor: 'rgba(54, 185, 204, 0.1)'
                    }]
                },
                options: commonOptions
            });

            window.soundChart = new Chart(document.getElementById('soundChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sound (dB)',
                        borderColor: '#f6c23e',
                        data: [],
                        fill: true,
                        backgroundColor: 'rgba(246, 194, 62, 0.1)'
                    }]
                },
                options: commonOptions
            });
        }

        // Update dashboard values
        function updateDashboardValues(data) {
            // Update main metrics
            document.getElementById('temperature').textContent = `${data.temperature.toFixed(1)}Â°C`;
            document.getElementById('humidity').textContent = `${data.humidity.toFixed(1)}%`;
            document.getElementById('weight').textContent = `${(data.weight/1000).toFixed(1)} kg`;
            document.getElementById('sound').textContent = `${data.sound.toFixed(0)}dB`;

            // Update status indicators
            updateStatus('temperature', data.temperature);
            updateStatus('humidity', data.humidity);
            updateStatus('weight', data.weight/1000); // Convert to kg
            updateStatus('sound', data.sound);

            // Update health indicators
            updateHealthIndicators(data);
        }

        // Real-time monitoring using Supabase data
        async function startMonitoring() {
            async function updateMetrics() {
                try {
                    console.log('Updating metrics...');
                    const hiveData = await getHiveData();
                    console.log('Received hive data:', hiveData);
                    
                    if (hiveData) {
                        updateDashboardValues(hiveData);
                    }
                    
                    // Load historical data for the chart
                    const historicalData = await getHistoricalHiveData();
                    if (historicalData && historicalData.length > 0) {
                        updateChart(historicalData);
                    }
                } catch (error) {
                    console.error('Error updating metrics:', error);
                }
            }

            // Initial update
            await updateMetrics();

            // Set up interval for regular updates (every 5 seconds)
            setInterval(updateMetrics, 5000);
        }

        function updateChart(historicalData) {
            if (!window.metricsChart) return;

            // Filter data for last 24 hours
            const now = new Date().getTime();
            const last24Hours = now - (24 * 60 * 60 * 1000);
            const filteredData = historicalData.filter(d => new Date(d.created_at).getTime() > last24Hours);

            const timestamps = filteredData.map(d => new Date(d.created_at).getTime());

            // Update main overview chart
            window.metricsChart.data.labels = timestamps;
            window.metricsChart.data.datasets[0].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.temperature
            }));
            window.metricsChart.data.datasets[1].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.humidity
            }));
            window.metricsChart.data.datasets[2].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.weight/1000 // Convert to kg
            }));
            window.metricsChart.data.datasets[3].data = filteredData.map(d => ({
                x: new Date(d.created_at).getTime(),
                y: d.sound
            }));
            window.metricsChart.update();

            // Update individual charts with filtered data
            if (window.temperatureChart) {
                window.temperatureChart.data.labels = timestamps;
                window.temperatureChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.temperature
                }));
                window.temperatureChart.update();
            }

            if (window.humidityChart) {
                window.humidityChart.data.labels = timestamps;
                window.humidityChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.humidity
                }));
                window.humidityChart.update();
            }

            if (window.weightChart) {
                window.weightChart.data.labels = timestamps;
                window.weightChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.weight/1000 // Convert to kg
                }));
                window.weightChart.update();
            }

            if (window.soundChart) {
                window.soundChart.data.labels = timestamps;
                window.soundChart.data.datasets[0].data = filteredData.map(d => ({
                    x: new Date(d.created_at).getTime(),
                    y: d.sound
                }));
                window.soundChart.update();
            }
        }

        // Thresholds adjusted based on actual data ranges (weight in kg)
        const thresholds = {
            temperature: { min: 25, max: 36 },
            humidity: { min: 50, max: 70 },
            weight: { min: 1.2, max: 1.6 }, // Converted to kg
            sound: { min: 30, max: 50 }
        };

        // Update status indicators and show alerts
        function updateStatus(metric, value) {
            console.log(`Updating status for ${metric}:`, value);
            const threshold = thresholds[metric];
            const status = document.getElementById(`${metric}-status`);
            const indicator = document.getElementById(`${metric}-indicator`);
            
            if (!status || !indicator) {
                console.error(`Missing elements for ${metric}-status or ${metric}-indicator`);
                return;
            }
            
            let alertMessage = '';
            let alertType = '';
            
            if (value < threshold.min) {
                status.textContent = 'Low';
                status.className = 'text-danger';
                indicator.textContent = 'Below Normal';
                
                // Create alert message for low values
                if (metric === 'temperature') {
                    alertMessage = `Warning: Temperature is too low (${value.toFixed(1)}Â°C). Minimum safe temperature is ${threshold.min}Â°C.`;
                    alertType = 'warning';
                } else if (metric === 'humidity') {
                    alertMessage = `Warning: Humidity is too low (${value.toFixed(1)}%). Minimum safe humidity is ${threshold.min}%.`;
                    alertType = 'warning';
                }
            } else if (value > threshold.max) {
                status.textContent = 'High';
                status.className = 'text-danger';
                indicator.textContent = 'Above Normal';
                
                // Create alert message for high values
                if (metric === 'temperature') {
                    alertMessage = `Alert: Temperature is too high (${value.toFixed(1)}Â°C). Maximum safe temperature is ${threshold.max}Â°C.`;
                    alertType = 'danger';
                } else if (metric === 'humidity') {
                    alertMessage = `Alert: Humidity is too high (${value.toFixed(1)}%). Maximum safe humidity is ${threshold.max}%.`;
                    alertType = 'danger';
                }
            } else {
                status.textContent = 'Normal';
                status.className = 'text-success';
                indicator.textContent = 'Optimal Range';
            }
            
            // Show alert if there's a message
            if (alertMessage) {
                showAlert(alertMessage, alertType, metric);
            }
        }

        // Function to show alerts in the alerts center
        function showAlert(message, type, metric) {
            const alertsContainer = document.querySelector('.dropdown-list');
            if (!alertsContainer) return;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();
            
            // Create alert HTML
            const alertHtml = `
                <a class="dropdown-item d-flex align-items-center" href="#">
                    <div class="me-3">
                        <div class="bg-${type} icon-circle">
                            <i class="fas ${metric === 'temperature' ? 'fa-thermometer-high' : 'fa-tint'} text-white"></i>
                        </div>
                    </div>
                    <div>
                        <span class="small text-gray-500">${dateString} at ${timeString}</span>
                        <p>${message}</p>
                    </div>
                </a>
            `;
            
            // Insert the new alert at the top (after the header)
            const header = alertsContainer.querySelector('.dropdown-header');
            if (header) {
                header.insertAdjacentHTML('afterend', alertHtml);
                
                // Update the alert counter
                const counter = document.querySelector('.badge-counter');
                if (counter) {
                    const currentCount = parseInt(counter.textContent) || 0;
                    counter.textContent = currentCount + 1;
                }
                
                // Optional: Play a notification sound
                playAlertSound();
            }
        }

        // Function to play alert sound
        function playAlertSound() {
            // Create an audio element
            const audio = new Audio('assets/sounds/alert.mp3');
            audio.volume = 0.5; // Set volume to 50%
            audio.play().catch(error => {
                console.log('Audio playback failed:', error);
            });
        }

        // Update health indicators based on current values
        function updateHealthIndicators(hiveData) {
            if (!hiveData) return;

            function updateProgressBar(elementId, value) {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.log(`Progress bar element ${elementId} not found`);
                    return;
                }
                const progressBar = element.previousElementSibling?.querySelector('.progress-bar');
                if (!progressBar) {
                    console.log(`Progress bar not found for ${elementId}`);
                    return;
                }
                const normalizedValue = Math.max(0, Math.min(100, value));
                progressBar.style.width = `${normalizedValue}%`;
                progressBar.setAttribute('aria-valuenow', normalizedValue);
            }

            try {
                // Calculate temperature stability
                const tempOptimal = 26.5;
                const tempStability = 100 - Math.abs((hiveData.temperature || 0) - tempOptimal) * 20;
                const tempElement = document.getElementById('temp-stability');
                if (tempElement) {
                    tempElement.textContent = `${Math.max(0, Math.min(100, tempStability)).toFixed(0)}%`;
                }

                // Calculate humidity balance
                const humidityOptimal = 48;
                const humidityBalance = 100 - Math.abs((hiveData.humidity || 0) - humidityOptimal) * 2;
                const humidityElement = document.getElementById('humidity-balance');
                if (humidityElement) {
                    humidityElement.textContent = `${Math.max(0, Math.min(100, humidityBalance)).toFixed(0)}%`;
                }

                // Calculate colony activity
                const activityOptimal = 40;
                const colonyActivity = 100 - Math.abs((hiveData.sound || 0) - activityOptimal) * 2;
                const activityElement = document.getElementById('colony-activity');
                if (activityElement) {
                    activityElement.textContent = `${Math.max(0, Math.min(100, colonyActivity)).toFixed(0)}%`;
                }

                // Calculate honey production
                const honeyProduction = Math.min(100, ((hiveData.weight || 0) / 1600) * 100);
                const productionElement = document.getElementById('honey-production');
                if (productionElement) {
                    productionElement.textContent = `${Math.max(0, Math.min(100, honeyProduction)).toFixed(0)}%`;
                }

                // Update progress bars
                updateProgressBar('temp-stability', tempStability);
                updateProgressBar('humidity-balance', humidityBalance);
                updateProgressBar('colony-activity', colonyActivity);
                updateProgressBar('honey-production', honeyProduction);
            } catch (error) {
                console.error('Error updating health indicators:', error);
            }
        }

        async function handleLogout() {
            await logout();
        }

        function updateAlertsDropdown() {
            const alerts = alertsManager.getLatestAlerts(3);
            const alertsCount = alertsManager.getUnreadCount();
            
            document.getElementById('alertsCount').textContent = alertsCount > 0 ? (alertsCount > 3 ? '3+' : alertsCount) : '';
            
            const alertsHtml = alerts.map(alert => `
                <a class="dropdown-item d-flex align-items-center" href="alerts.html">
                    <div class="me-3">
                        <div class="bg-${alert.type} icon-circle">
                            <i class="fas ${getAlertIcon(alert.metric)} text-white"></i>
                        </div>
                    </div>
                    <div>
                        <span class="small text-gray-500">${new Date(alert.created_at).toLocaleString()}</span>
                        <p class="mb-0">${alert.message}</p>
                    </div>
                </a>
            `).join('') || '<div class="dropdown-item text-center">No alerts</div>';
            
            document.getElementById('alertsDropdown').innerHTML = alertsHtml;
        }

        function updateMessagesDropdown() {
            const messages = messagesManager.getLatestMessages(3);
            const messagesCount = messagesManager.getUnreadCount();
            
            document.getElementById('messagesCount').textContent = messagesCount > 0 ? (messagesCount > 3 ? '3+' : messagesCount) : '';
            
            const messagesHtml = messages.map(message => `
                <a class="dropdown-item d-flex align-items-center" href="messages.html">
                    <div class="me-3">
                        <div class="bg-${getMessagePriorityClass(message.priority)} icon-circle">
                            <i class="fas ${getMessageIcon(message.type)} text-white"></i>
                        </div>
                    </div>
                    <div>
                        <div class="fw-bold">
                            <div class="text-truncate">${message.title}</div>
                            <div class="small text-gray-500">${new Date(message.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                </a>
            `).join('') || '<div class="dropdown-item text-center">No messages</div>';
            
            document.getElementById('messagesDropdown').innerHTML = messagesHtml;
        }

        function getAlertIcon(metric) {
            switch (metric) {
                case 'temperature': return 'fa-thermometer-high';
                case 'humidity': return 'fa-tint';
                case 'weight': return 'fa-weight';
                case 'sound': return 'fa-volume-up';
                default: return 'fa-exclamation-triangle';
            }
        }

        function getMessageIcon(type) {
            switch (type) {
                case 'system': return 'fa-cog';
                case 'notification': return 'fa-bell';
                case 'update': return 'fa-sync';
                default: return 'fa-envelope';
            }
        }

        function getMessagePriorityClass(priority) {
            switch (priority) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                default: return 'info';
            }
        }

        // Update dropdowns periodically
        document.addEventListener('DOMContentLoaded', () => {
            updateAlertsDropdown();
            updateMessagesDropdown();
            
            // Update every 30 seconds
            setInterval(() => {
                updateAlertsDropdown();
                updateMessagesDropdown();
            }, 30000);
        });
    </script>
</body>

</html>